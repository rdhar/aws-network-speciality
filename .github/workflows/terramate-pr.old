# name: OpenTofu Preview

# on:
#   pull_request:
#     types: [opened, synchronize]
#     branches: [main]

# # Disable permissions for all available scopes
# permissions: {}

# concurrency:
#   group: ${{ github.workflow }}-${{ github.repository }}
#   cancel-in-progress: true

# jobs:
#   preview:
#     name: Plan OpenTofu changes in changed Terramate stacks
#     permissions:
#       id-token: write
#       contents: read
#       pull-requests: write
#       checks: read
#     runs-on: ubuntu-latest
#     timeout-minutes: 30
#     env:
#       TF_TOKEN_APP_TERRAFORM_IO: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}

#     steps:
#       # Create Pull Request comment
#       - name: Prepare pull request preview comment
#         if: github.event.pull_request
#         uses: marocchino/sticky-pull-request-comment@331f8f5b4215f0445d3c07b4967662a32a2d3e31 # v2.9.0
#         with:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#           header: preview
#           message: |
#             ## Preview of OpeTofu changes in ${{ github.event.pull_request.head.sha }}

#             :warning: preview is being created... please stand by!

#       # Check out the code
#       - name: Checkout
#         uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
#         with:
#           ref: ${{ github.head_ref }}
#           fetch-depth: 0

#       # Install tooling
#       - name: Install Terramate
#         uses: terramate-io/terramate-action@b5d1461d435ba454179045ea062bbecb32738913 # v2.0.0

#       - name: Setup OpenTofu
#         uses: opentofu/setup-opentofu@12f4debbf681675350b6cd1f0ff8ecfbda62027b # v1.0.4
#         with:
#           tofu_version: 1.8.2
#           tofu_wrapper: false

#       # Linting
#       - name: Check Terramate formatting
#         run: terramate fmt --check

#       - name: Check OpenTofu formatting
#         run: tofu fmt -recursive -check -diff

#       # Check for changed stacks
#       - name: List changed stacks
#         id: list
#         run: terramate list --changed

#       # Configure cloud credentials
#       - name: Configure AWS credentials via OIDC
#         if: steps.list.outputs.stdout
#         uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
#         with:
#           aws-region: us-east-1
#           role-to-assume: ${{ secrets.AWS_ANS_OIDC_ROLE_ARN }}
#           role-external-id: ${{ secrets.AWS_ANS_OIDC_EXTERNAL_ID }}

#       # Run the opentofu preview via Terramate in each changed stack
#       - name: Initialize OpenTofu in changed stacks
#         if: steps.list.outputs.stdout
#         run: terramate run --parallel 1 --changed -- tofu init -lock-timeout=5m

#       - name: Validate OpenTofu configuration in changed stacks
#         if: steps.list.outputs.stdout
#         run: terramate run --parallel 5 --changed -- tofu validate

#       - name: Plan OpenTofu changes in changed stacks
#         if: steps.list.outputs.stdout
#         run: |
#           terramate run --parallel 5 --changed --sync-preview --tofu-plan-file=out.tfplan --debug-preview-url preview_url.txt --continue-on-error -- tofu plan -out out.tfplan -detailed-exitcode -lock=false
#         env:
#           GITHUB_TOKEN: ${{ github.token }}

#       # Update Pull Request comment
#       - name: Generate preview details
#         if: steps.list.outputs.stdout
#         id: comment
#         run: |
#           echo >>pr-comment.txt "## Preview of OpenTofu changes in ${{ github.event.pull_request.head.sha }}"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt "[:mag: View Details on Terramate Cloud]($(cat preview_url.txt))"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt "### Changed Stacks"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt '```bash'
#           echo >>pr-comment.txt "${{ steps.list.outputs.stdout }}"
#           echo >>pr-comment.txt '```'
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt "#### OpenTofu Plan"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt '```OpenTofu'
#           terramate run --disable-safeguards=all --changed -- tofu show -no-color out.tfplan |& dd bs=1024 count=248 >>pr-comment.txt
#           [ "${PIPESTATUS[0]}" == "141" ] && sed -i 's/#### opentofu Plan/#### :warning: OpenTofu Plan truncated: please check console output :warning:/' pr-comment.txt
#           echo >>pr-comment.txt '```'
#           cat pr-comment.txt >>$GITHUB_STEP_SUMMARY

#       - name: Generate preview when no stacks changed
#         if: success() && !steps.list.outputs.stdout
#         run: |
#           echo >>pr-comment.txt "## Preview of OpenTofu changes in ${{ github.event.pull_request.head.sha }}"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt "### Changed Stacks"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt 'No changed stacks, no detailed preview will be generated.'
#           cat pr-comment.txt >>$GITHUB_STEP_SUMMARY

#       - name: Generate preview when things failed
#         if: failure()
#         run: |
#           echo >>pr-comment.txt "## Preview of OpenTofu changes in ${{ github.event.pull_request.head.sha }}"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt "[:mag: View Details on Terramate Cloud]($(cat preview_url.txt))"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt "### Changed Stacks"
#           echo >>pr-comment.txt
#           echo >>pr-comment.txt '```bash'
#           echo >>pr-comment.txt "${{ steps.list.outputs.stdout }}"
#           echo >>pr-comment.txt '```'
#           echo >>pr-comment.txt ':boom: Generating preview failed. Please see details in Actions output.'
#           cat pr-comment.txt >>$GITHUB_STEP_SUMMARY

#       - name: Publish generated preview as GitHub comment
#         uses: marocchino/sticky-pull-request-comment@331f8f5b4215f0445d3c07b4967662a32a2d3e31 # v2.9.0
#         with:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#           header: preview
#           path: pr-comment.txt
